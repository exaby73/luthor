{"version":3,"sources":["../src/index.ts","../src/ec-config.ts","../src/renderer.ts","../src/astro-config.ts","../src/vite-plugin.ts"],"sourcesContent":["import type { AstroIntegration } from 'astro'\nimport type { RehypeExpressiveCodeOptions } from 'rehype-expressive-code'\nimport rehypeExpressiveCode from 'rehype-expressive-code'\nimport { ConfigSetupHookArgs, PartialAstroConfig } from './astro-config'\nimport { AstroExpressiveCodeOptions, CustomConfigPreprocessors, ConfigPreprocessorFn, getEcConfigFileUrl, loadEcConfigFile } from './ec-config'\nimport { createAstroRenderer } from './renderer'\nimport { vitePluginAstroExpressiveCode } from './vite-plugin'\n\nexport * from 'rehype-expressive-code'\n\nexport type { AstroExpressiveCodeOptions, PartialAstroConfig, CustomConfigPreprocessors, ConfigPreprocessorFn }\nexport * from './renderer'\n\n/**\n * Astro integration that adds Expressive Code support to code blocks in Markdown & MDX documents.\n */\nexport function astroExpressiveCode(integrationOptions: AstroExpressiveCodeOptions = {}) {\n\tconst integration = {\n\t\tname: 'astro-expressive-code',\n\t\thooks: {\n\t\t\t'astro:config:setup': async (args: unknown) => {\n\t\t\t\tconst { command, config: astroConfig, updateConfig, logger, addWatchFile } = args as ConfigSetupHookArgs\n\n\t\t\t\t// Validate Astro configuration\n\t\t\t\tconst ownPosition = astroConfig.integrations.findIndex((integration) => integration.name === 'astro-expressive-code')\n\t\t\t\tconst mdxPosition = astroConfig.integrations.findIndex((integration) => integration.name === '@astrojs/mdx')\n\t\t\t\tif (ownPosition > -1 && mdxPosition > -1 && mdxPosition < ownPosition) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`Incorrect integration order: To allow code blocks on MDX pages to use\n\t\t\t\t\t\tastro-expressive-code, please move astroExpressiveCode() before mdx()\n\t\t\t\t\t\tin the \"integrations\" array of your Astro config file.`.replace(/\\s+/g, ' ')\n\t\t\t\t\t)\n\t\t\t\t}\n\n\t\t\t\t// Watch the EC config file for changes (including creation/deletion)\n\t\t\t\taddWatchFile(getEcConfigFileUrl(astroConfig.root))\n\n\t\t\t\t// Merge the given options with the ones from a potential EC config file\n\t\t\t\tconst ecConfigFileOptions = await loadEcConfigFile(astroConfig.root)\n\t\t\t\tconst mergedOptions: AstroExpressiveCodeOptions = { ...ecConfigFileOptions, ...integrationOptions }\n\n\t\t\t\t// Warn if the user is both using an EC config file and passing options directly\n\t\t\t\tconst forwardedIntegrationOptions = { ...integrationOptions }\n\t\t\t\tdelete forwardedIntegrationOptions.customConfigPreprocessors\n\t\t\t\tif (Object.keys(ecConfigFileOptions).length > 0 && Object.keys(forwardedIntegrationOptions).length > 0) {\n\t\t\t\t\tlogger.warn(\n\t\t\t\t\t\t`Your project includes an Expressive Code config file (\"ec.config.mjs\"),\n\t\t\t\t\t\tbut your Astro config file also contains Expressive Code options.\n\t\t\t\t\t\tTo avoid unexpected results from merging multiple config sources,\n\t\t\t\t\t\tmove all Expressive Code options into its config file.\n\t\t\t\t\t\tFound options: ${Object.keys(forwardedIntegrationOptions).join(', ')}`.replace(/\\s+/g, ' ')\n\t\t\t\t\t)\n\t\t\t\t}\n\n\t\t\t\t// Preprocess the merged config if custom preprocessors were provided\n\t\t\t\tconst processedEcConfig = (await mergedOptions.customConfigPreprocessors?.preprocessAstroIntegrationConfig({ ecConfig: mergedOptions, astroConfig })) || mergedOptions\n\n\t\t\t\t// Prepare config to pass to the rehype integration\n\t\t\t\tconst { customCreateAstroRenderer } = processedEcConfig\n\t\t\t\tdelete processedEcConfig.customCreateAstroRenderer\n\t\t\t\tdelete processedEcConfig.customConfigPreprocessors\n\n\t\t\t\tconst { hashedStyles, hashedScripts, ...renderer } = await (customCreateAstroRenderer ?? createAstroRenderer)({ astroConfig, ecConfig: processedEcConfig, logger })\n\n\t\t\t\tconst rehypeExpressiveCodeOptions: RehypeExpressiveCodeOptions = {\n\t\t\t\t\t// Even though we have created a custom renderer, some options are used\n\t\t\t\t\t// by the rehype integration itself (e.g. `tabWidth`, `getBlockLocale`),\n\t\t\t\t\t// so we pass all of them through just to be safe\n\t\t\t\t\t...processedEcConfig,\n\t\t\t\t\t// Pass our custom renderer to the rehype integration\n\t\t\t\t\tcustomCreateRenderer: () => renderer,\n\t\t\t\t}\n\n\t\t\t\tupdateConfig({\n\t\t\t\t\tvite: {\n\t\t\t\t\t\tplugins: [\n\t\t\t\t\t\t\tvitePluginAstroExpressiveCode({\n\t\t\t\t\t\t\t\tstyles: hashedStyles,\n\t\t\t\t\t\t\t\tscripts: hashedScripts,\n\t\t\t\t\t\t\t\tecIntegrationOptions: integrationOptions,\n\t\t\t\t\t\t\t\tastroConfig,\n\t\t\t\t\t\t\t\tcommand,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t\tmarkdown: {\n\t\t\t\t\t\tsyntaxHighlight: false,\n\t\t\t\t\t\trehypePlugins: [[rehypeExpressiveCode, rehypeExpressiveCodeOptions]],\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t},\n\t\t},\n\t} satisfies AstroIntegration\n\n\treturn integration\n}\n\n/**\n * A utility function that helps you define an Expressive Code configuration object. It is meant\n * to be used inside the optional config file `ec.config.mjs` located in the root directory\n * of your Astro project, and its return value to be exported as the default export.\n *\n * Expressive Code will automatically detect this file and use the exported configuration object\n * to override its own default settings.\n *\n * Using this function is recommended, but not required. It just passes through the given object,\n * but it also provides type information for your editor's auto-completion and type checking.\n *\n * @example\n * ```js\n * // ec.config.mjs\n * import { defineEcConfig } from 'astro-expressive-code'\n *\n * export default defineEcConfig({\n *   themes: ['dracula', 'github-light'],\n *   styleOverrides: {\n *     borderRadius: '0.5rem',\n *   },\n * })\n * ```\n */\nexport function defineEcConfig(config: AstroExpressiveCodeOptions) {\n\treturn config\n}\n\n// Provide a default export for convenience and `astro add astro-expressive-code` compatibility\nexport default astroExpressiveCode\n","import type { RehypeExpressiveCodeOptions } from 'rehype-expressive-code'\nimport type { PartialAstroConfig } from './astro-config'\nimport type { AstroExpressiveCodeRenderer, CreateAstroRendererArgs } from './renderer'\n\nexport type AstroExpressiveCodeOptions = RehypeExpressiveCodeOptions & {\n\t/**\n\t * Determines if the styles required to display code blocks should be emitted into a separate\n\t * CSS file rather than being inlined into the rendered HTML of the first code block per page.\n\t *\n\t * This is recommended for sites containing multiple pages with code blocks, as it will reduce\n\t * the overall footprint of the site when navigating between pages.\n\t *\n\t * The generated URL is located inside Astro's assets directory and includes a content hash\n\t * so it can be cached indefinitely by browsers. If you are using the default values for the\n\t * Astro config options `base`, `build.assets`, `build.assetsPrefix`, the resulting URL\n\t * will be `/_astro/ec.{hash}.css`.\n\t *\n\t * **Important**: To actually benefit from caching, please ensure that your hosting provider\n\t * serves the contents of the assets directory as immutable files with a long cache lifetime,\n\t * e.g. `Cache-Control: public,max-age=31536000,immutable`.\n\t *\n\t * @default true\n\t */\n\temitExternalStylesheet?: boolean | undefined\n\t/**\n\t * This advanced option allows you to influence the rendering process by creating\n\t * your own `AstroExpressiveCodeRenderer` or processing the base styles and JS modules\n\t * added to every page.\n\t *\n\t * The return value will be cached and used for all code blocks on the site.\n\t */\n\tcustomCreateAstroRenderer?: ((args: CreateAstroRendererArgs) => Promise<AstroExpressiveCodeRenderer> | AstroExpressiveCodeRenderer) | undefined\n\t/**\n\t * This advanced option allows you to preprocess the Expressive Code configuration\n\t * before it is used by the Astro integration or its exported `<Code>` component.\n\t *\n\t * For example, Starlight uses this option to provide different default settings\n\t * and additional theme options.\n\t */\n\tcustomConfigPreprocessors?: CustomConfigPreprocessors | undefined\n}\n\nexport type CustomConfigPreprocessors = {\n\t/**\n\t * To perform preprocessing on the Expressive Code configuration before it is used\n\t * by the Astro integration, set this property to a function. It will be called with\n\t * an object argument that contains the following properties:\n\t * - `ecConfig`: an Expressive Code config object merged from the optional EC config file\n\t *   `ec.config.mjs` and any options passed directly to the integration\n\t * - `astroConfig`: an object containing commonly used settings from the Astro configuration\n\t *\n\t * The return value must be a valid Expressive Code configuration object.\n\t */\n\tpreprocessAstroIntegrationConfig: ConfigPreprocessorFn\n\t/**\n\t * If you set `preprocessAstroIntegrationConfig` to a function, you must also set this property\n\t * to the JS source code of a Vite virtual module that exports the same function as its\n\t * default export.\n\t *\n\t * This is necessary to allow the `<Code>` component to access the same preprocessed config\n\t * as the Astro integration. The Astro integration cannot share the function directly with\n\t * the `<Code>` component because it runs in a separate Vite instance.\n\t */\n\tpreprocessComponentConfig: string\n}\n\nexport type ConfigPreprocessorFn = (args: { ecConfig: unknown; astroConfig: PartialAstroConfig }) => Promise<AstroExpressiveCodeOptions> | AstroExpressiveCodeOptions\n\n/**\n * Returns a URL to the optional EC config file in the Astro project root.\n */\nexport function getEcConfigFileUrl(projectRootUrl: URL | string) {\n\treturn new URL('./ec.config.mjs', projectRootUrl)\n}\n\n/**\n * Attempts to import an EC config file in the Astro project root and returns its default export.\n *\n * If no config file is found, an empty object is returned.\n */\nexport async function loadEcConfigFile(projectRootUrl: URL | string): Promise<AstroExpressiveCodeOptions> {\n\tconst pathsToTry = [\n\t\t// This path works in most scenarios, but not when the integration is processed by Vite\n\t\t// due to a Vite bug affecting import URLs using the \"file:\" protocol\n\t\tnew URL(`./ec.config.mjs?t=${Date.now()}`, projectRootUrl).href,\n\t]\n\t// Detect if the integration is processed by Vite\n\tif (import.meta.env?.BASE_URL?.length) {\n\t\t// Add a fallback path starting with \"/\", which Vite treats as relative to the project root\n\t\tpathsToTry.push(`/ec.config.mjs?t=${Date.now()}`)\n\t}\n\t/**\n\t * Checks the error received on attempting to import EC config file.\n\t * Bun's choice to throw ResolveMessage for import resolver messages means\n\t * type comparison (error instanceof Error) isn't portable.\n\t * @param error Error object, which could be string, Error, or ResolveMessage.\n\t * @returns object containing message and, if present, error code.\n\t */\n\tfunction coerceError(error: unknown): { message: string; code?: string | undefined } {\n\t\tif (typeof error === 'object' && error !== null && 'message' in error) {\n\t\t\treturn error as { message: string; code?: string | undefined }\n\t\t}\n\t\treturn { message: error as string }\n\t}\n\tfor (const path of pathsToTry) {\n\t\ttry {\n\t\t\tconst module = (await import(/* @vite-ignore */ path)) as { default: AstroExpressiveCodeOptions }\n\t\t\tif (!module.default) {\n\t\t\t\tthrow new Error(`Missing or invalid default export. Please export your Expressive Code config object as the default export.`)\n\t\t\t}\n\t\t\treturn module.default\n\t\t} catch (error) {\n\t\t\tconst { message, code } = coerceError(error)\n\t\t\t// If the config file was not found, continue with the next path (if any)\n\t\t\tif (code === 'ERR_MODULE_NOT_FOUND' || code === 'ERR_LOAD_URL') {\n\t\t\t\t// Ignore the error only if the config file itself was not found,\n\t\t\t\t// not if the config file failed to import another module\n\t\t\t\t// - Node: Cannot find module '.../ec.config.mjs' imported from .../astro-expressive-code/dist/index.js\n\t\t\t\t// - Bun:  Cannot find module \".../ec.config.mjs\" from \".../astro-expressive-code/dist/index.js\"\n\t\t\t\t// - Vite: .../ec.config.mjs at .../ec.config.mjs (imported from ...)\n\t\t\t\tif (message.replace(/(imported )?from .*$/, '').includes('ec.config.mjs')) continue\n\t\t\t}\n\t\t\t// If the config file exists, but there was a problem loading it, rethrow the error\n\t\t\tthrow new Error(\n\t\t\t\t`Your project includes an Expressive Code config file (\"ec.config.mjs\")\n\t\t\t\tthat could not be loaded due to ${code ? `the error ${code}` : 'the following error'}: ${message}`.replace(/\\s+/g, ' '),\n\t\t\t\terror instanceof Error ? { cause: error } : undefined\n\t\t\t)\n\t\t}\n\t}\n\treturn {}\n}\n","import { RehypeExpressiveCodeRenderer, createRenderer, getStableObjectHash } from 'rehype-expressive-code'\nimport { AstroExpressiveCodeOptions } from './ec-config'\nimport { PartialAstroConfig, ConfigSetupHookArgs, getAssetsBaseHref } from './astro-config'\n\nexport type CreateAstroRendererArgs = {\n\tecConfig: AstroExpressiveCodeOptions\n\tastroConfig: PartialAstroConfig\n\tlogger?: ConfigSetupHookArgs['logger'] | undefined\n}\n\nexport type AstroExpressiveCodeRenderer = RehypeExpressiveCodeRenderer & {\n\thashedStyles: [string, string][]\n\thashedScripts: [string, string][]\n}\n\nexport async function createAstroRenderer({ ecConfig, astroConfig, logger }: CreateAstroRendererArgs): Promise<AstroExpressiveCodeRenderer> {\n\t// Process the merged options and apply defaults\n\tconst { emitExternalStylesheet = true, customCreateRenderer, plugins = [], shiki = true, ...rest } = ecConfig ?? {}\n\n\t// Determine the assets directory and href prefix from the Astro config\n\tconst assetsDir = astroConfig.build?.assets || '_astro'\n\n\t// Add a plugin that inserts external references to the styles and scripts\n\t// that would normally be inlined into the first code block of every page\n\tconst hashedStyles: [string, string][] = []\n\tconst hashedScripts: [string, string][] = []\n\tplugins.push({\n\t\tname: 'astro-expressive-code',\n\t\thooks: {\n\t\t\tpostprocessRenderedBlockGroup: ({ renderData, renderedGroupContents }) => {\n\t\t\t\t// Only continue if this is the first code block group of the page\n\t\t\t\tconst isFirstGroupInDocument = renderedGroupContents[0]?.codeBlock.parentDocument?.positionInDocument?.groupIndex === 0\n\t\t\t\tif (!isFirstGroupInDocument) return\n\n\t\t\t\ttype HastElement = Extract<(typeof renderData.groupAst.children)[number], { type: 'element' }>\n\t\t\t\tconst extraElements: HastElement[] = []\n\n\t\t\t\t// Add hashed stylesheet links\n\t\t\t\thashedStyles.forEach(([hashedRoute]) => {\n\t\t\t\t\textraElements.push({\n\t\t\t\t\t\ttype: 'element',\n\t\t\t\t\t\ttagName: 'link',\n\t\t\t\t\t\tproperties: { rel: 'stylesheet', href: `${getAssetsBaseHref('.css', astroConfig.build?.assetsPrefix, astroConfig.base)}${hashedRoute}` },\n\t\t\t\t\t\tchildren: [],\n\t\t\t\t\t})\n\t\t\t\t})\n\n\t\t\t\t// Add hashed script module links for all JS modules\n\t\t\t\thashedScripts.forEach(([hashedRoute]) => {\n\t\t\t\t\textraElements.push({\n\t\t\t\t\t\ttype: 'element',\n\t\t\t\t\t\ttagName: 'script',\n\t\t\t\t\t\tproperties: { type: 'module', src: `${getAssetsBaseHref('.js', astroConfig.build?.assetsPrefix, astroConfig.base)}${hashedRoute}` },\n\t\t\t\t\t\tchildren: [],\n\t\t\t\t\t})\n\t\t\t\t})\n\n\t\t\t\tif (!extraElements.length) return\n\t\t\t\trenderData.groupAst.children.unshift(...extraElements)\n\t\t\t},\n\t\t},\n\t})\n\n\t// Unless Shiki was disabled, merge any supported Shiki settings\n\t// from the Astro config into the plugin options\n\tconst mergedShikiConfig = shiki === true ? {} : shiki\n\tif (mergedShikiConfig && !mergedShikiConfig.langs && astroConfig.markdown?.shikiConfig?.langs) {\n\t\tmergedShikiConfig.langs = astroConfig.markdown.shikiConfig.langs as NonNullable<typeof mergedShikiConfig.langs>\n\t}\n\n\t// Create the renderer\n\tconst renderer = (await (customCreateRenderer ?? createRenderer)({\n\t\tplugins,\n\t\tlogger,\n\t\tshiki: mergedShikiConfig,\n\t\t...rest,\n\t})) as AstroExpressiveCodeRenderer\n\trenderer.hashedStyles = hashedStyles\n\trenderer.hashedScripts = hashedScripts\n\n\t// Unless disabled, move the base and theme styles from the inline renderer\n\t// into an external CSS file that can be cached by browsers\n\tif (emitExternalStylesheet) {\n\t\tconst combinedStyles = `${renderer.baseStyles}${renderer.themeStyles}`\n\t\thashedStyles.push(getHashedRouteWithContent(combinedStyles, `/${assetsDir}/ec.{hash}.css`))\n\t\trenderer.baseStyles = ''\n\t\trenderer.themeStyles = ''\n\t}\n\n\t// Also move any JS modules into a single external file\n\t// (this is always enabled because the alternative using `injectScript`\n\t// does not allow omitting the scripts on pages without any code blocks)\n\tconst uniqueJsModules = [...new Set<string>(renderer.jsModules)]\n\tconst mergedJsCode = uniqueJsModules.join('\\n')\n\trenderer.jsModules = []\n\thashedScripts.push(getHashedRouteWithContent(mergedJsCode, `/${assetsDir}/ec.{hash}.js`))\n\n\treturn renderer\n}\n\n/**\n * Generates a hashed route and content tuple for a given content string.\n */\nfunction getHashedRouteWithContent(content: string, routeTemplate: string): [string, string] {\n\tconst contentHash = getStableObjectHash(content, { hashLength: 5 })\n\treturn [routeTemplate.replace('{hash}', contentHash), content]\n}\n","import type { AstroIntegration } from 'astro'\n\n// As the arguments of the `astro:config:setup` hook are incompatible between Astro versions,\n// we just access this type internally and accept `unknown` args externally to prevent\n// version-specific types from being included in the build output\nexport type ConfigSetupHookArgs = Parameters<NonNullable<AstroIntegration['hooks']['astro:config:setup']>>[0]\nexport type AstroConfig = ConfigSetupHookArgs['config']\nexport type AssetsPrefix = AstroConfig['build']['assetsPrefix']\n\n/**\n * Contains the parts of the Astro config that are used by this integration.\n */\nexport type PartialAstroConfig = Pick<AstroConfig, 'base' | 'root' | 'srcDir'> & {\n\tbuild?: Partial<Pick<AstroConfig['build'], 'assets' | 'assetsPrefix'>> | undefined\n\tmarkdown?:\n\t\t| Partial<{\n\t\t\t\tshikiConfig: Partial<Pick<AstroConfig['markdown']['shikiConfig'], 'langs'>>\n\t\t  }>\n\t\t| undefined\n}\n\nexport function serializePartialAstroConfig(config: PartialAstroConfig): string {\n\tconst partialConfig: PartialAstroConfig = {\n\t\tbase: config.base,\n\t\troot: config.root,\n\t\tsrcDir: config.srcDir,\n\t}\n\tif (config.build) {\n\t\tpartialConfig.build = {}\n\t\tif (config.build.assets) partialConfig.build.assets = config.build.assets\n\t\tif (config.build.assetsPrefix) partialConfig.build.assetsPrefix = config.build.assetsPrefix\n\t}\n\tif (config.markdown?.shikiConfig?.langs) {\n\t\tpartialConfig.markdown = { shikiConfig: { langs: config.markdown.shikiConfig.langs } }\n\t}\n\treturn JSON.stringify(partialConfig)\n}\n\nfunction getAssetsPrefix(fileExtension: string, assetsPrefix?: AssetsPrefix): string {\n\tif (!assetsPrefix) return ''\n\tif (typeof assetsPrefix === 'string') return assetsPrefix\n\t// we assume the file extension has a leading '.' and we remove it\n\tconst dotLessFileExtension = fileExtension.slice(1)\n\tif (assetsPrefix[dotLessFileExtension]) {\n\t\treturn assetsPrefix[dotLessFileExtension]\n\t}\n\treturn assetsPrefix.fallback\n}\n\n/**\n * Returns the base URL href for assets with the given file extension (e.g. `.js`).\n *\n * The returned value does not include a trailing slash.\n */\nexport function getAssetsBaseHref(fileExtension: string, assetsPrefix: AssetsPrefix | undefined, base: string | undefined): string {\n\treturn (getAssetsPrefix(fileExtension, assetsPrefix) || base || '').trim().replace(/\\/+$/g, '')\n}\n","import type { ViteUserConfig } from 'astro'\nimport { stableStringify } from 'rehype-expressive-code'\nimport { getEcConfigFileUrl } from './ec-config'\nimport { PartialAstroConfig, serializePartialAstroConfig } from './astro-config'\nimport { AstroExpressiveCodeOptions } from './ec-config'\n\n/**\n * This Vite plugin provides access to page-wide styles & scripts that the Astro integration\n * extracted from its `RehypeExpressiveCodeRenderer`. We extract these contents from the renderer\n * to prevent the rehype plugin from repeatedly injecting them into the HTML output of every page\n * while still allowing pages to load them on demand if they contain code blocks.\n */\nexport function vitePluginAstroExpressiveCode({\n\tstyles,\n\tscripts,\n\tecIntegrationOptions,\n\tastroConfig,\n\tcommand,\n}: {\n\tstyles: [string, string][]\n\tscripts: [string, string][]\n\tecIntegrationOptions: AstroExpressiveCodeOptions\n\tastroConfig: PartialAstroConfig\n\tcommand: 'dev' | 'build' | 'preview'\n}): NonNullable<ViteUserConfig['plugins']>[number] {\n\tconst modules: Record<string, string> = {}\n\n\t// Create virtual config module\n\tconst configModuleContents: string[] = []\n\t// - Partial Astro config\n\tconfigModuleContents.push(`export const astroConfig = ${serializePartialAstroConfig(astroConfig)}`)\n\t// - Expressive Code integration options\n\tconst { customConfigPreprocessors, ...otherEcIntegrationOptions } = ecIntegrationOptions\n\tconfigModuleContents.push(`export const ecIntegrationOptions = ${stableStringify(otherEcIntegrationOptions)}`)\n\t// - Expressive Code config file options\n\tconst strEcConfigFileUrlHref = JSON.stringify(getEcConfigFileUrl(astroConfig.root).href)\n\tconfigModuleContents.push(\n\t\t`let ecConfigFileOptions = {}`,\n\t\t`try {`,\n\t\t`\tecConfigFileOptions = (await import('virtual:astro-expressive-code/ec-config')).default`,\n\t\t`} catch (e) {`,\n\t\t`\tconsole.error('*** Failed to load Expressive Code config file ${strEcConfigFileUrlHref}. You can ignore this message if you just renamed/removed the file.\\\\n\\\\n(Full error message: \"' + (e?.message || e) + '\")\\\\n')`,\n\t\t`}`,\n\t\t`export { ecConfigFileOptions }`\n\t)\n\tmodules['virtual:astro-expressive-code/config'] = configModuleContents.join('\\n')\n\n\t// This is a fallback that will only be used when no config file is present\n\tmodules['virtual:astro-expressive-code/ec-config'] = 'export default {}'\n\n\t// Create virtual config preprocessor module\n\tmodules['virtual:astro-expressive-code/preprocess-config'] = customConfigPreprocessors?.preprocessComponentConfig || `export default ({ ecConfig }) => ecConfig`\n\n\tconst noQuery = (source: string) => source.split('?')[0]\n\n\tconst getVirtualModuleContents = (source: string) => {\n\t\t// In dev mode, serve the extracted styles & scripts as virtual modules\n\t\tif (command === 'dev') {\n\t\t\tfor (const file of [...styles, ...scripts]) {\n\t\t\t\tconst [fileName, contents] = file\n\t\t\t\tif (noQuery(fileName) === noQuery(source)) return contents\n\t\t\t}\n\t\t}\n\t\treturn source in modules ? modules[source] : undefined\n\t}\n\n\treturn {\n\t\tname: 'vite-plugin-astro-expressive-code',\n\t\tasync resolveId(source, importer) {\n\t\t\t// Resolve virtual API module to the current package entrypoint\n\t\t\tif (source === 'virtual:astro-expressive-code/api') {\n\t\t\t\tconst resolved = await this.resolve('astro-expressive-code', importer)\n\t\t\t\tif (resolved) return resolved\n\t\t\t\treturn await this.resolve('astro-expressive-code')\n\t\t\t}\n\t\t\t// Resolve EC config file if present\n\t\t\tif (source === 'virtual:astro-expressive-code/ec-config') {\n\t\t\t\tconst resolved = await this.resolve('./ec.config.mjs')\n\t\t\t\tif (resolved) return resolved\n\t\t\t}\n\t\t\t// Resolve other virtual modules\n\t\t\tif (getVirtualModuleContents(source)) return `\\0${source}`\n\t\t},\n\t\tload: (id) => (id?.[0] === '\\0' ? getVirtualModuleContents(id.slice(1)) : undefined),\n\t\t// If any file imported by the EC config file changes, restart the server\n\t\tasync handleHotUpdate({ modules, server }) {\n\t\t\tif (!modules || !server) return\n\t\t\tconst isImportedByEcConfig = (module: (typeof modules)[0], depth: number = 0) => {\n\t\t\t\tif (!module || !module.importers || depth >= 6) return false\n\t\t\t\tfor (const importingModule of module.importers) {\n\t\t\t\t\tif (noQuery(module.url).endsWith('/ec.config.mjs')) {\n\t\t\t\t\t\treturn true\n\t\t\t\t\t}\n\t\t\t\t\tif (isImportedByEcConfig(importingModule, depth + 1)) return true\n\t\t\t\t}\n\t\t\t\treturn false\n\t\t\t}\n\t\t\tif (modules.some((module) => isImportedByEcConfig(module))) {\n\t\t\t\tawait server.restart()\n\t\t\t}\n\t\t},\n\t\tbuildEnd() {\n\t\t\t// In build mode, emit the extracted styles & scripts as static assets\n\t\t\tif (command === 'build') {\n\t\t\t\tfor (const file of [...styles, ...scripts]) {\n\t\t\t\t\tconst [fileName, source] = file\n\t\t\t\t\tthis.emitFile({\n\t\t\t\t\t\ttype: 'asset',\n\t\t\t\t\t\t// Remove leading slash and any query params\n\t\t\t\t\t\tfileName: noQuery(fileName.slice(1)),\n\t\t\t\t\t\tsource,\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t}\n}\n"],"mappings":";AAEA,OAAO,0BAA0B;;;ACqE1B,SAAS,mBAAmB,gBAA8B;AAChE,SAAO,IAAI,IAAI,mBAAmB,cAAc;AACjD;AAOA,eAAsB,iBAAiB,gBAAmE;AACzG,QAAM,aAAa;AAAA;AAAA;AAAA,IAGlB,IAAI,IAAI,qBAAqB,KAAK,IAAI,CAAC,IAAI,cAAc,EAAE;AAAA,EAC5D;AAEA,MAAI,YAAY,KAAK,UAAU,QAAQ;AAEtC,eAAW,KAAK,oBAAoB,KAAK,IAAI,CAAC,EAAE;AAAA,EACjD;AAQA,WAAS,YAAY,OAAgE;AACpF,QAAI,OAAO,UAAU,YAAY,UAAU,QAAQ,aAAa,OAAO;AACtE,aAAO;AAAA,IACR;AACA,WAAO,EAAE,SAAS,MAAgB;AAAA,EACnC;AACA,aAAW,QAAQ,YAAY;AAC9B,QAAI;AACH,YAAM,SAAU,MAAM;AAAA;AAAA,QAA0B;AAAA;AAChD,UAAI,CAAC,OAAO,SAAS;AACpB,cAAM,IAAI,MAAM,4GAA4G;AAAA,MAC7H;AACA,aAAO,OAAO;AAAA,IACf,SAAS,OAAO;AACf,YAAM,EAAE,SAAS,KAAK,IAAI,YAAY,KAAK;AAE3C,UAAI,SAAS,0BAA0B,SAAS,gBAAgB;AAM/D,YAAI,QAAQ,QAAQ,wBAAwB,EAAE,EAAE,SAAS,eAAe;AAAG;AAAA,MAC5E;AAEA,YAAM,IAAI;AAAA,QACT;AAAA,sCACkC,OAAO,aAAa,IAAI,KAAK,qBAAqB,KAAK,OAAO,GAAG,QAAQ,QAAQ,GAAG;AAAA,QACtH,iBAAiB,QAAQ,EAAE,OAAO,MAAM,IAAI;AAAA,MAC7C;AAAA,IACD;AAAA,EACD;AACA,SAAO,CAAC;AACT;;;ACnIA,SAAuC,gBAAgB,2BAA2B;;;ACqB3E,SAAS,4BAA4B,QAAoC;AAC/E,QAAM,gBAAoC;AAAA,IACzC,MAAM,OAAO;AAAA,IACb,MAAM,OAAO;AAAA,IACb,QAAQ,OAAO;AAAA,EAChB;AACA,MAAI,OAAO,OAAO;AACjB,kBAAc,QAAQ,CAAC;AACvB,QAAI,OAAO,MAAM;AAAQ,oBAAc,MAAM,SAAS,OAAO,MAAM;AACnE,QAAI,OAAO,MAAM;AAAc,oBAAc,MAAM,eAAe,OAAO,MAAM;AAAA,EAChF;AACA,MAAI,OAAO,UAAU,aAAa,OAAO;AACxC,kBAAc,WAAW,EAAE,aAAa,EAAE,OAAO,OAAO,SAAS,YAAY,MAAM,EAAE;AAAA,EACtF;AACA,SAAO,KAAK,UAAU,aAAa;AACpC;AAEA,SAAS,gBAAgB,eAAuB,cAAqC;AACpF,MAAI,CAAC;AAAc,WAAO;AAC1B,MAAI,OAAO,iBAAiB;AAAU,WAAO;AAE7C,QAAM,uBAAuB,cAAc,MAAM,CAAC;AAClD,MAAI,aAAa,oBAAoB,GAAG;AACvC,WAAO,aAAa,oBAAoB;AAAA,EACzC;AACA,SAAO,aAAa;AACrB;AAOO,SAAS,kBAAkB,eAAuB,cAAwC,MAAkC;AAClI,UAAQ,gBAAgB,eAAe,YAAY,KAAK,QAAQ,IAAI,KAAK,EAAE,QAAQ,SAAS,EAAE;AAC/F;;;ADzCA,eAAsB,oBAAoB,EAAE,UAAU,aAAa,OAAO,GAAkE;AAE3I,QAAM,EAAE,yBAAyB,MAAM,sBAAsB,UAAU,CAAC,GAAG,QAAQ,MAAM,GAAG,KAAK,IAAI,YAAY,CAAC;AAGlH,QAAM,YAAY,YAAY,OAAO,UAAU;AAI/C,QAAM,eAAmC,CAAC;AAC1C,QAAM,gBAAoC,CAAC;AAC3C,UAAQ,KAAK;AAAA,IACZ,MAAM;AAAA,IACN,OAAO;AAAA,MACN,+BAA+B,CAAC,EAAE,YAAY,sBAAsB,MAAM;AAEzE,cAAM,yBAAyB,sBAAsB,CAAC,GAAG,UAAU,gBAAgB,oBAAoB,eAAe;AACtH,YAAI,CAAC;AAAwB;AAG7B,cAAM,gBAA+B,CAAC;AAGtC,qBAAa,QAAQ,CAAC,CAAC,WAAW,MAAM;AACvC,wBAAc,KAAK;AAAA,YAClB,MAAM;AAAA,YACN,SAAS;AAAA,YACT,YAAY,EAAE,KAAK,cAAc,MAAM,GAAG,kBAAkB,QAAQ,YAAY,OAAO,cAAc,YAAY,IAAI,CAAC,GAAG,WAAW,GAAG;AAAA,YACvI,UAAU,CAAC;AAAA,UACZ,CAAC;AAAA,QACF,CAAC;AAGD,sBAAc,QAAQ,CAAC,CAAC,WAAW,MAAM;AACxC,wBAAc,KAAK;AAAA,YAClB,MAAM;AAAA,YACN,SAAS;AAAA,YACT,YAAY,EAAE,MAAM,UAAU,KAAK,GAAG,kBAAkB,OAAO,YAAY,OAAO,cAAc,YAAY,IAAI,CAAC,GAAG,WAAW,GAAG;AAAA,YAClI,UAAU,CAAC;AAAA,UACZ,CAAC;AAAA,QACF,CAAC;AAED,YAAI,CAAC,cAAc;AAAQ;AAC3B,mBAAW,SAAS,SAAS,QAAQ,GAAG,aAAa;AAAA,MACtD;AAAA,IACD;AAAA,EACD,CAAC;AAID,QAAM,oBAAoB,UAAU,OAAO,CAAC,IAAI;AAChD,MAAI,qBAAqB,CAAC,kBAAkB,SAAS,YAAY,UAAU,aAAa,OAAO;AAC9F,sBAAkB,QAAQ,YAAY,SAAS,YAAY;AAAA,EAC5D;AAGA,QAAM,WAAY,OAAO,wBAAwB,gBAAgB;AAAA,IAChE;AAAA,IACA;AAAA,IACA,OAAO;AAAA,IACP,GAAG;AAAA,EACJ,CAAC;AACD,WAAS,eAAe;AACxB,WAAS,gBAAgB;AAIzB,MAAI,wBAAwB;AAC3B,UAAM,iBAAiB,GAAG,SAAS,UAAU,GAAG,SAAS,WAAW;AACpE,iBAAa,KAAK,0BAA0B,gBAAgB,IAAI,SAAS,gBAAgB,CAAC;AAC1F,aAAS,aAAa;AACtB,aAAS,cAAc;AAAA,EACxB;AAKA,QAAM,kBAAkB,CAAC,GAAG,IAAI,IAAY,SAAS,SAAS,CAAC;AAC/D,QAAM,eAAe,gBAAgB,KAAK,IAAI;AAC9C,WAAS,YAAY,CAAC;AACtB,gBAAc,KAAK,0BAA0B,cAAc,IAAI,SAAS,eAAe,CAAC;AAExF,SAAO;AACR;AAKA,SAAS,0BAA0B,SAAiB,eAAyC;AAC5F,QAAM,cAAc,oBAAoB,SAAS,EAAE,YAAY,EAAE,CAAC;AAClE,SAAO,CAAC,cAAc,QAAQ,UAAU,WAAW,GAAG,OAAO;AAC9D;;;AEzGA,SAAS,uBAAuB;AAWzB,SAAS,8BAA8B;AAAA,EAC7C;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACD,GAMmD;AAClD,QAAM,UAAkC,CAAC;AAGzC,QAAM,uBAAiC,CAAC;AAExC,uBAAqB,KAAK,8BAA8B,4BAA4B,WAAW,CAAC,EAAE;AAElG,QAAM,EAAE,2BAA2B,GAAG,0BAA0B,IAAI;AACpE,uBAAqB,KAAK,uCAAuC,gBAAgB,yBAAyB,CAAC,EAAE;AAE7G,QAAM,yBAAyB,KAAK,UAAU,mBAAmB,YAAY,IAAI,EAAE,IAAI;AACvF,uBAAqB;AAAA,IACpB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA,kEAAkE,sBAAsB;AAAA,IACxF;AAAA,IACA;AAAA,EACD;AACA,UAAQ,sCAAsC,IAAI,qBAAqB,KAAK,IAAI;AAGhF,UAAQ,yCAAyC,IAAI;AAGrD,UAAQ,iDAAiD,IAAI,2BAA2B,6BAA6B;AAErH,QAAM,UAAU,CAAC,WAAmB,OAAO,MAAM,GAAG,EAAE,CAAC;AAEvD,QAAM,2BAA2B,CAAC,WAAmB;AAEpD,QAAI,YAAY,OAAO;AACtB,iBAAW,QAAQ,CAAC,GAAG,QAAQ,GAAG,OAAO,GAAG;AAC3C,cAAM,CAAC,UAAU,QAAQ,IAAI;AAC7B,YAAI,QAAQ,QAAQ,MAAM,QAAQ,MAAM;AAAG,iBAAO;AAAA,MACnD;AAAA,IACD;AACA,WAAO,UAAU,UAAU,QAAQ,MAAM,IAAI;AAAA,EAC9C;AAEA,SAAO;AAAA,IACN,MAAM;AAAA,IACN,MAAM,UAAU,QAAQ,UAAU;AAEjC,UAAI,WAAW,qCAAqC;AACnD,cAAM,WAAW,MAAM,KAAK,QAAQ,yBAAyB,QAAQ;AACrE,YAAI;AAAU,iBAAO;AACrB,eAAO,MAAM,KAAK,QAAQ,uBAAuB;AAAA,MAClD;AAEA,UAAI,WAAW,2CAA2C;AACzD,cAAM,WAAW,MAAM,KAAK,QAAQ,iBAAiB;AACrD,YAAI;AAAU,iBAAO;AAAA,MACtB;AAEA,UAAI,yBAAyB,MAAM;AAAG,eAAO,KAAK,MAAM;AAAA,IACzD;AAAA,IACA,MAAM,CAAC,OAAQ,KAAK,CAAC,MAAM,OAAO,yBAAyB,GAAG,MAAM,CAAC,CAAC,IAAI;AAAA;AAAA,IAE1E,MAAM,gBAAgB,EAAE,SAAAA,UAAS,OAAO,GAAG;AAC1C,UAAI,CAACA,YAAW,CAAC;AAAQ;AACzB,YAAM,uBAAuB,CAAC,QAA6B,QAAgB,MAAM;AAChF,YAAI,CAAC,UAAU,CAAC,OAAO,aAAa,SAAS;AAAG,iBAAO;AACvD,mBAAW,mBAAmB,OAAO,WAAW;AAC/C,cAAI,QAAQ,OAAO,GAAG,EAAE,SAAS,gBAAgB,GAAG;AACnD,mBAAO;AAAA,UACR;AACA,cAAI,qBAAqB,iBAAiB,QAAQ,CAAC;AAAG,mBAAO;AAAA,QAC9D;AACA,eAAO;AAAA,MACR;AACA,UAAIA,SAAQ,KAAK,CAAC,WAAW,qBAAqB,MAAM,CAAC,GAAG;AAC3D,cAAM,OAAO,QAAQ;AAAA,MACtB;AAAA,IACD;AAAA,IACA,WAAW;AAEV,UAAI,YAAY,SAAS;AACxB,mBAAW,QAAQ,CAAC,GAAG,QAAQ,GAAG,OAAO,GAAG;AAC3C,gBAAM,CAAC,UAAU,MAAM,IAAI;AAC3B,eAAK,SAAS;AAAA,YACb,MAAM;AAAA;AAAA,YAEN,UAAU,QAAQ,SAAS,MAAM,CAAC,CAAC;AAAA,YACnC;AAAA,UACD,CAAC;AAAA,QACF;AAAA,MACD;AAAA,IACD;AAAA,EACD;AACD;;;AJ5GA,cAAc;AAQP,SAAS,oBAAoB,qBAAiD,CAAC,GAAG;AACxF,QAAM,cAAc;AAAA,IACnB,MAAM;AAAA,IACN,OAAO;AAAA,MACN,sBAAsB,OAAO,SAAkB;AAC9C,cAAM,EAAE,SAAS,QAAQ,aAAa,cAAc,QAAQ,aAAa,IAAI;AAG7E,cAAM,cAAc,YAAY,aAAa,UAAU,CAACC,iBAAgBA,aAAY,SAAS,uBAAuB;AACpH,cAAM,cAAc,YAAY,aAAa,UAAU,CAACA,iBAAgBA,aAAY,SAAS,cAAc;AAC3G,YAAI,cAAc,MAAM,cAAc,MAAM,cAAc,aAAa;AACtE,gBAAM,IAAI;AAAA,YACT;AAAA;AAAA,8DAEwD,QAAQ,QAAQ,GAAG;AAAA,UAC5E;AAAA,QACD;AAGA,qBAAa,mBAAmB,YAAY,IAAI,CAAC;AAGjD,cAAM,sBAAsB,MAAM,iBAAiB,YAAY,IAAI;AACnE,cAAM,gBAA4C,EAAE,GAAG,qBAAqB,GAAG,mBAAmB;AAGlG,cAAM,8BAA8B,EAAE,GAAG,mBAAmB;AAC5D,eAAO,4BAA4B;AACnC,YAAI,OAAO,KAAK,mBAAmB,EAAE,SAAS,KAAK,OAAO,KAAK,2BAA2B,EAAE,SAAS,GAAG;AACvG,iBAAO;AAAA,YACN;AAAA;AAAA;AAAA;AAAA,uBAIiB,OAAO,KAAK,2BAA2B,EAAE,KAAK,IAAI,CAAC,GAAG,QAAQ,QAAQ,GAAG;AAAA,UAC3F;AAAA,QACD;AAGA,cAAM,oBAAqB,MAAM,cAAc,2BAA2B,iCAAiC,EAAE,UAAU,eAAe,YAAY,CAAC,KAAM;AAGzJ,cAAM,EAAE,0BAA0B,IAAI;AACtC,eAAO,kBAAkB;AACzB,eAAO,kBAAkB;AAEzB,cAAM,EAAE,cAAc,eAAe,GAAG,SAAS,IAAI,OAAO,6BAA6B,qBAAqB,EAAE,aAAa,UAAU,mBAAmB,OAAO,CAAC;AAElK,cAAM,8BAA2D;AAAA;AAAA;AAAA;AAAA,UAIhE,GAAG;AAAA;AAAA,UAEH,sBAAsB,MAAM;AAAA,QAC7B;AAEA,qBAAa;AAAA,UACZ,MAAM;AAAA,YACL,SAAS;AAAA,cACR,8BAA8B;AAAA,gBAC7B,QAAQ;AAAA,gBACR,SAAS;AAAA,gBACT,sBAAsB;AAAA,gBACtB;AAAA,gBACA;AAAA,cACD,CAAC;AAAA,YACF;AAAA,UACD;AAAA,UACA,UAAU;AAAA,YACT,iBAAiB;AAAA,YACjB,eAAe,CAAC,CAAC,sBAAsB,2BAA2B,CAAC;AAAA,UACpE;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACD;AAAA,EACD;AAEA,SAAO;AACR;AA0BO,SAAS,eAAe,QAAoC;AAClE,SAAO;AACR;AAGA,IAAO,cAAQ;","names":["modules","integration"]}